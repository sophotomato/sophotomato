<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Sopho Tomato</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Sopho Tomato">
<meta property="og:url" content="https://sophotomato.github.io/index.html">
<meta property="og:site_name" content="Sopho Tomato">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sopho Tomato">
  
    <link rel="alternate" href="/atom.xml" title="Sopho Tomato" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Sopho Tomato</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://sophotomato.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/hello-world2/" class="article-date">
  <time datetime="2017-12-30T12:38:26.374Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/30/hello-world2/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/12/30/hello-world2/" data-id="cjbtc2ng1000bh8s9sugdtlo6" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/hello-world/" class="article-date">
  <time datetime="2017-12-30T12:02:24.498Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/30/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/12/30/hello-world/" data-id="cjbtc2nfv0007h8s9p0f88cpf" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-gcc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/14/gcc/" class="article-date">
  <time datetime="2017-10-14T12:56:04.000Z" itemprop="datePublished">2017-10-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/14/gcc/">gcc</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="include-lt-gt-与-inlucde-“”"><a href="#include-lt-gt-与-inlucde-“”" class="headerlink" title="#include &lt;&gt;与#inlucde “”"></a>#include &lt;&gt;与#inlucde “”</h4><p>#include &lt;&gt; 会直接到系统指定的目录中去找头文件。<br>#include “” 先到源文件所在文件夹去找，然后再到系统指定的目录中去找头文件。</p>
<h4 id="gcc指定头文件的三种情况："><a href="#gcc指定头文件的三种情况：" class="headerlink" title="gcc指定头文件的三种情况："></a>gcc指定头文件的三种情况：</h4><ol>
<li>会在默认情况下指定到/usr/include文件夹</li>
<li>gcc使用了-I指定路径的方式<br>-I dir<br> Add the directory dir to the list of directories to be searched for<br> header files.  Directories named by -I are searched before the<br> standard system include directories.  If the directory dir is a<br> standard system include directory, the option is ignored to ensure<br> that the default search order for system directories and the<br> special treatment of system headers are not defeated .  If dir<br> begins with “=”, then the “=” will be replaced by the sysroot<br> prefix; see –sysroot and -isysroot.</li>
<li>参数：-nostdinc使编译器不再系统缺省的头文件目录里面找头文件,一般和-I联合使用,明确限定头文件的位置。</li>
</ol>
<p>注：参数：-nostdinc使编译器不再系统缺省的头文件目录里面找头文件,一般和-I联合使用,明确限定头文件的位置。</p>
<h4 id="头文件搜索顺序："><a href="#头文件搜索顺序：" class="headerlink" title="头文件搜索顺序："></a>头文件搜索顺序：</h4><ol>
<li>由参数-I指定的路径(指定路径有多个路径时，按指定路径的顺序搜索)</li>
<li>然后找gcc的环境变量 C_INCLUDE_PATH, CPLUS_INCLUDE_PATH, OBJC_INCLUDE_PATH</li>
<li>再找系统指定目录<br>/usr/include<br>/usr/local/include<br>/usr/lib/gcc/x86_64-linux-gnu/5.4.0/include<h4 id="动态库"><a href="#动态库" class="headerlink" title="动态库"></a>动态库</h4>我们通过以下命令用源程序lib_test.c来创建动态库 lib_test.so。<br># gcc –o lib_test.o -c lib_test.c<br># gcc -shared -fPIC -o lib_test.so lib_test.o<br>#<br>或者直接一条指令：<br>#gcc –shared –fPIC –o lib_test.so lib_test.c<br>#<br>注意：<br>-fPIC参数声明链接库的代码段是可以共享的，<br>-shared参数声明编译为共享库。请注意这次我们编译的共享库的名字叫做<br>lib_test.so，这也是Linux共享库的一个命名的惯例了：后缀使用so，而名称使用libxxxx格式。</li>
</ol>
<p>接着通过以下命令编译main.c,生成目标程序main.out。<br># gcc -o main.out -L. –l_test main.c<br>#</p>
<p>请注意为什么是-l_test?</p>
<p>然后把库文件移动到目录/root/lib中。<br># mkdir /root/lib<br># mv lib_test.so /root/lib/ lib_test.so<br>#</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/10/14/gcc/" data-id="cjbtc2nfk0002h8s979xgnlxn" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gcc/">gcc</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ip-rcv-finish" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/10/ip-rcv-finish/" class="article-date">
  <time datetime="2017-10-10T13:40:12.000Z" itemprop="datePublished">2017-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/10/ip-rcv-finish/">ip_rcv_finish()处理sk_buff数据分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>所有源码来自<a href="https://www.kernel.org" target="_blank" rel="noopener">kernel.org</a><br>内核版本号3.10</p>
</blockquote>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ip_rcv_finish</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> = <span class="title">ip_hdr</span>(<span class="title">skb</span>);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> *<span class="title">rt</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sysctl_ip_early_demux &amp;&amp; !skb_dst(skb)) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_protocol</span> *<span class="title">ipprot</span>;</span></span><br><span class="line">		<span class="keyword">int</span> protocol = iph-&gt;protocol;</span><br><span class="line"></span><br><span class="line">		ipprot = rcu_dereference(inet_protos[protocol]);</span><br><span class="line">		<span class="keyword">if</span> (ipprot &amp;&amp; ipprot-&gt;early_demux) &#123;</span><br><span class="line">			ipprot-&gt;early_demux(skb);</span><br><span class="line">			<span class="comment">/* must reload iph, skb-&gt;head might have changed */</span></span><br><span class="line">			iph = ip_hdr(skb);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 *	Initialise the virtual path cache for the packet. It describes</span></span><br><span class="line"><span class="comment">	 *	how the packet travels inside Linux networking.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!skb_dst(skb)) &#123;	<span class="comment">//方法skb_dst()用于检查是否有于skb相关联的dst对象</span></span><br><span class="line">		<span class="keyword">int</span> err = ip_route_input_noref(skb, iph-&gt;daddr, iph-&gt;saddr,</span><br><span class="line">					       iph-&gt;tos, skb-&gt;dev);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(err)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (err == -EXDEV)</span><br><span class="line">				NET_INC_STATS_BH(dev_net(skb-&gt;dev),</span><br><span class="line">						 LINUX_MIB_IPRPFILTER);</span><br><span class="line">			<span class="keyword">goto</span> drop;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_CLASSID</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(skb_dst(skb)-&gt;tclassid)) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">ip_rt_acct</span> *<span class="title">st</span> = <span class="title">this_cpu_ptr</span>(<span class="title">ip_rt_acct</span>);</span></span><br><span class="line">		u32 idx = skb_dst(skb)-&gt;tclassid;</span><br><span class="line">		st[idx&amp;<span class="number">0xFF</span>].o_packets++;</span><br><span class="line">		st[idx&amp;<span class="number">0xFF</span>].o_bytes += skb-&gt;len;</span><br><span class="line">		st[(idx&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xFF</span>].i_packets++;</span><br><span class="line">		st[(idx&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xFF</span>].i_bytes += skb-&gt;len;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iph-&gt;ihl &gt; <span class="number">5</span> &amp;&amp; ip_rcv_options(skb))</span><br><span class="line">		<span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line">	rt = skb_rtable(skb);	<span class="comment">//获取rtable，根据rt_type，统计数据？</span></span><br><span class="line">	<span class="keyword">if</span> (rt-&gt;rt_type == RTN_MULTICAST) &#123;</span><br><span class="line">		IP_UPD_PO_STATS_BH(dev_net(rt-&gt;dst.dev), IPSTATS_MIB_INMCAST,</span><br><span class="line">				skb-&gt;len);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rt-&gt;rt_type == RTN_BROADCAST)</span><br><span class="line">		IP_UPD_PO_STATS_BH(dev_net(rt-&gt;dst.dev), IPSTATS_MIB_INBCAST,</span><br><span class="line">				skb-&gt;len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dst_input(skb);</span><br><span class="line"></span><br><span class="line">drop:</span><br><span class="line">	kfree_skb(skb);</span><br><span class="line">	<span class="keyword">return</span> NET_RX_DROP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>获取ip报文头；</li>
<li>检测skb是否有关联的dst_entry对象，若没有则，使用ip_route_input_noref()进行查找；</li>
<li>如果ip报文头大于20个字节((iphdr)-&gt;ihl)， 则调用方法ip_rcv_options()对可选项部分进行处理；</li>
<li>通过调用dst_input()方法，来执行(dst_entry)-&gt;input()方法对skb进行处理，回调函数input()是在路由选择子系统中查找时会设置，如需要转发数据包，则将其设置为ip_forward()，数据包的目的地址为本机，则将其设置为ip_local_deliver()，对于组播数据包，可能将其设置为ip_mr_input()。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/10/10/ip-rcv-finish/" data-id="cjbtc2ng8000dh8s9d935la0h" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内核网络/">内核网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ip-rcv" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/10/ip-rcv/" class="article-date">
  <time datetime="2017-10-10T13:39:57.000Z" itemprop="datePublished">2017-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/10/ip-rcv/">ip_rcv()处理sk_buff数据分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>所有源码来自<a href="https://www.kernel.org" target="_blank" rel="noopener">kernel.org</a><br>内核版本号3.10</p>
</blockquote>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 	Main IP Receive routine.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ip_rcv</span><span class="params">(struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *orig_dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">	u32 len;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* When the interface is in promisc. mode, drop all the crap</span></span><br><span class="line"><span class="comment">	 * that it receives, do not try to analyse it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;pkt_type == PACKET_OTHERHOST) <span class="comment">//该值在方法eth_type_trans()中确定，判断依据目标MAC地址</span></span><br><span class="line">		<span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	IP_UPD_PO_STATS_BH(dev_net(dev), IPSTATS_MIB_IN, skb-&gt;len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((skb = skb_share_check(skb, GFP_ATOMIC)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		IP_INC_STATS_BH(dev_net(dev), IPSTATS_MIB_INDISCARDS);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pskb_may_pull(skb, <span class="keyword">sizeof</span>(struct iphdr)))</span><br><span class="line">		<span class="keyword">goto</span> inhdr_error;</span><br><span class="line"></span><br><span class="line">	iph = ip_hdr(skb);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 *	RFC1122: 3.2.1.2 MUST silently discard any IP frame that fails the checksum.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *	Is the datagram acceptable?</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *	1.	Length at least the size of an ip header</span></span><br><span class="line"><span class="comment">	 *	2.	Version of 4</span></span><br><span class="line"><span class="comment">	 *	3.	Checksums correctly. [Speed optimisation for later, skip loopback checksums]</span></span><br><span class="line"><span class="comment">	 *	4.	Doesn't have a bogus length</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (iph-&gt;ihl &lt; <span class="number">5</span> || iph-&gt;version != <span class="number">4</span>)</span><br><span class="line">		<span class="keyword">goto</span> inhdr_error;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pskb_may_pull(skb, iph-&gt;ihl*<span class="number">4</span>))</span><br><span class="line">		<span class="keyword">goto</span> inhdr_error;</span><br><span class="line"></span><br><span class="line">	iph = ip_hdr(skb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ip_fast_csum((u8 *)iph, iph-&gt;ihl)))</span><br><span class="line">		<span class="keyword">goto</span> csum_error;</span><br><span class="line"></span><br><span class="line">	len = ntohs(iph-&gt;tot_len);</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;len &lt; len) &#123;</span><br><span class="line">		IP_INC_STATS_BH(dev_net(dev), IPSTATS_MIB_INTRUNCATEDPKTS);</span><br><span class="line">		<span class="keyword">goto</span> drop;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &lt; (iph-&gt;ihl*<span class="number">4</span>))</span><br><span class="line">		<span class="keyword">goto</span> inhdr_error;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Our transport medium may have padded the buffer out. Now we know it</span></span><br><span class="line"><span class="comment">	 * is IP we can trim to the true length of the frame.</span></span><br><span class="line"><span class="comment">	 * Note this now means skb-&gt;len holds ntohs(iph-&gt;tot_len).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (pskb_trim_rcsum(skb, len)) &#123;</span><br><span class="line">		IP_INC_STATS_BH(dev_net(dev), IPSTATS_MIB_INDISCARDS);</span><br><span class="line">		<span class="keyword">goto</span> drop;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Remove any debris废墟 in the socket control block */</span></span><br><span class="line">	<span class="built_in">memset</span>(IPCB(skb), <span class="number">0</span>, <span class="keyword">sizeof</span>(struct inet_skb_parm));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Must drop socket now because of tproxy. */</span></span><br><span class="line">	skb_orphan(skb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING, skb, dev, <span class="literal">NULL</span>,</span><br><span class="line">		       ip_rcv_finish);		<span class="comment">//钩子函数ipv4_conntrack_in</span></span><br><span class="line"></span><br><span class="line">csum_error:</span><br><span class="line">	IP_INC_STATS_BH(dev_net(dev), IPSTATS_MIB_CSUMERRORS);</span><br><span class="line">inhdr_error:</span><br><span class="line">	IP_INC_STATS_BH(dev_net(dev), IPSTATS_MIB_INHDRERRORS);</span><br><span class="line">drop:</span><br><span class="line">	kfree_skb(skb);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> NET_RX_DROP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * (sk_buff)-&gt;pkt_type;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************/</span></span><br><span class="line"><span class="comment">/* Packet types */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_HOST		0		<span class="comment">/* To us		*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_BROADCAST	1		<span class="comment">/* To all		*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_MULTICAST	2		<span class="comment">/* To group		*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_OTHERHOST	3		<span class="comment">/* To someone else 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_OUTGOING		4		<span class="comment">/* Outgoing of any type */</span></span></span><br><span class="line"><span class="comment">/* These ones are invisible by user level */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_LOOPBACK		5		<span class="comment">/* MC/BRD frame looped back */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_FASTROUTE	6		<span class="comment">/* Fastrouted frame	*/</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>检查skb-&gt;pkt_type;</li>
<li>获取ip header</li>
<li>校验和计算</li>
<li>获取ip报文的总长度（包括header在内）</li>
<li>重新计算校验和</li>
<li>清空(sk_buff)-&gt;cb控制缓冲区</li>
<li>设置（destructor = NULL; sk = NULL;）</li>
<li>调用ip_rcv_finish()，进行下一步处理</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/10/10/ip-rcv/" data-id="cjbtc2ngb000fh8s96kdt0zrr" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内核网络/">内核网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-IPv4路由子选择系统" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/10/09/IPv4路由子选择系统/" class="article-date">
  <time datetime="2017-10-09T11:25:01.000Z" itemprop="datePublished">2017-10-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/09/IPv4路由子选择系统/">IPv4路由子选择系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>所有源码来自<a href="https://www.kernel.org" target="_blank" rel="noopener">kernel.org</a><br>内核版本号3.10</p>
</blockquote>
<h4 id="IPv4处理接收包过程"><a href="#IPv4处理接收包过程" class="headerlink" title="IPv4处理接收包过程"></a>IPv4处理接收包过程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ip_rcv()</span><br><span class="line">  -&gt;ip_rcv_finish()</span><br><span class="line">    -&gt;ip_route_input_noref()</span><br><span class="line">      -&gt;ip_route_input_slow()</span><br><span class="line">        -&gt;fib_lookup()</span><br><span class="line">          -&gt;fib_table_lookup()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>关于<code>fib_table_lookup()</code>查表的内容可查看本站其他博文。</p>
<h5 id="路由表"><a href="#路由表" class="headerlink" title="路由表"></a>路由表</h5></blockquote>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*************************************</span></span><br><span class="line"><span class="comment"> * (struct rtable) = (struct dst_entry) = (skb-&gt;_skb_refdst)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span>	<span class="title">dst</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			rt_genid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		rt_flags;</span><br><span class="line">	__u16			rt_type;</span><br><span class="line">	__u8			rt_is_input;  <span class="comment">//输入路由设置为1</span></span><br><span class="line">	__u8			rt_uses_gateway; <span class="comment">//下一跳为网关设置为1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			rt_iif;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Info on neighbour */</span></span><br><span class="line">	__be32			rt_gateway;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Miscellaneous cached information */</span></span><br><span class="line">	u32			rt_pmtu; <span class="comment">//路径MTU(路途上最小的MTU)</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">rt_uncached</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*********************************</span></span><br><span class="line"><span class="comment">-&gt;rt_flags</span></span><br><span class="line"><span class="comment">  RTCF_BROADCAST:目标地址为广播地址。在__mkroute_output()和ip_route_input_slow()中设置</span></span><br><span class="line"><span class="comment">  RTCF_MULTICAST:目标地址为组播地址。在ip_route_input_mc()和__mkroute_output()设置。</span></span><br><span class="line"><span class="comment">  RTCF_DOREDIRECT:必需发送一条ICMPv4重定向消息。在__mkroute_input()中设置。</span></span><br><span class="line"><span class="comment">  RTCF_LOCAL:目的地为当前主机。在ip_route_input_slow()、__mkroute_output()、ip_route_input_mc()、__ip_route_output_key()中设置。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fib_result</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	prefixlen;	<span class="comment">//前缀长度，表示子网掩码</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	nh_sel;		<span class="comment">//下一跳数量</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	type;		<span class="comment">//决定处理数据包的方式</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	scope;</span><br><span class="line">	u32		tclassid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_info</span> *<span class="title">fi</span>;</span>		<span class="comment">//fib_info指向下一跳的引用(fib_nh)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_table</span> *<span class="title">table</span>;</span>	<span class="comment">//指向用于查找的table</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">fa_head</span>;</span>	<span class="comment">//指向一个fib_alias列表</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="FIB表"><a href="#FIB表" class="headerlink" title="FIB表"></a>FIB表</h5><figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*************************************</span></span><br><span class="line"><span class="comment"> * struct trie *t = (struct trie *) (struct fib_table)-&gt;tb_data;</span></span><br><span class="line"><span class="comment"> * struct rt_trie_node *n = t-&gt;trie;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * (struct leaf *) = (struct leaf *) n;</span></span><br><span class="line"><span class="comment"> * (struct tnode *) = (struct tnode *) n;</span></span><br><span class="line"><span class="comment"> *************************************/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fib_table</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>	<span class="title">tb_hlist</span>;</span></span><br><span class="line">	u32			tb_id;	<span class="comment">//路由选择表标识符</span></span><br><span class="line">	<span class="keyword">int</span>			tb_default;</span><br><span class="line">	<span class="keyword">int</span>			tb_num_default;	<span class="comment">//表中包含默认路由数</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		tb_data[<span class="number">0</span>];	<span class="comment">//路由选择条目对象(trie)的占位符。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This structure contains data shared by many of routes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fib_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>	<span class="title">fib_hash</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>	<span class="title">fib_lhash</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span>		*<span class="title">fib_net</span>;</span>  <span class="comment">//所属network namespace</span></span><br><span class="line">	<span class="keyword">int</span>			fib_treeref; <span class="comment">//包含该fib_info的fib_alias对象的个数</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		fib_clntref;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		fib_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		fib_dead;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		fib_protocol; <span class="comment">//段后注释</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		fib_scope;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		fib_type;</span><br><span class="line">	__be32			fib_prefsrc;</span><br><span class="line">	u32			fib_priority;  <span class="comment">//路由优先级，默认0（最大优先级）</span></span><br><span class="line">	u32			*fib_metrics;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fib_mtu fib_metrics[RTAX_MTU-1]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fib_window fib_metrics[RTAX_WINDOW-1]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fib_rtt fib_metrics[RTAX_RTT-1]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fib_advmss fib_metrics[RTAX_ADVMSS-1]</span></span><br><span class="line">	<span class="keyword">int</span>			fib_nhs;   <span class="comment">//下一跳的数量</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_MULTIPATH</span></span><br><span class="line">	<span class="keyword">int</span>			fib_power;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_nh</span>		<span class="title">fib_nh</span>[0];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fib_dev		fib_nh[0].nh_dev</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment">-&gt;fib_protocol</span></span><br><span class="line"><span class="comment">RTPROT_UNSPEC:一个错误值</span></span><br><span class="line"><span class="comment">RTPROT_REDIRECT:路由选择条目是因收到ICMP重定向消息而创建的。仅用于IPv6中</span></span><br><span class="line"><span class="comment">RTPROT_KERNEL:路由选择条目由内核创建</span></span><br><span class="line"><span class="comment">RTPROT_BOOT:路由是由管理员添加，切且没有使用proto static 修饰符</span></span><br><span class="line"><span class="comment">RTPROT_STATIC:路由是由管理员添加</span></span><br><span class="line"><span class="comment">RTPROT_RA:RDISC/ND路由器通告，仅用于IPv6子系统</span></span><br><span class="line"><span class="comment">************************************/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fib_alias</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">fa_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_info</span>		*<span class="title">fa_info</span>;</span></span><br><span class="line">	u8			fa_tos;</span><br><span class="line">	u8			fa_type;</span><br><span class="line">	u8			fa_state;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 路由类型 */</span></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">	RTN_UNSPEC,</span><br><span class="line">	RTN_UNICAST,		<span class="comment">/* Gateway or direct route	*/</span></span><br><span class="line">	RTN_LOCAL,		<span class="comment">/* Accept locally		*/</span></span><br><span class="line">	RTN_BROADCAST,		<span class="comment">/* Accept locally as broadcast,</span></span><br><span class="line"><span class="comment">				   send as broadcast */</span></span><br><span class="line">	RTN_ANYCAST,		<span class="comment">/* Accept locally as broadcast,</span></span><br><span class="line"><span class="comment">				   but send as unicast */</span></span><br><span class="line">	RTN_MULTICAST,		<span class="comment">/* Multicast route		*/</span></span><br><span class="line">	RTN_BLACKHOLE,		<span class="comment">/* Drop				*/</span></span><br><span class="line">	RTN_UNREACHABLE,	<span class="comment">/* Destination is unreachable   */</span></span><br><span class="line">	RTN_PROHIBIT,		<span class="comment">/* Administratively prohibited	*/</span></span><br><span class="line">	RTN_THROW,		<span class="comment">/* Not in this table		*/</span></span><br><span class="line">	RTN_NAT,		<span class="comment">/* Translate this address	*/</span></span><br><span class="line">	RTN_XRESOLVE,		<span class="comment">/* Use external resolver	*/</span></span><br><span class="line">	__RTN_MAX</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>Linux符号</th>
<th>错误值</th>
<th>范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>RTN_UNSPEC</td>
<td>0</td>
<td>RT_SCOPE_NOWHERE</td>
</tr>
<tr>
<td>RTN_UNICAST</td>
<td>0</td>
<td>RT_SCOPE_UNIVERSE</td>
</tr>
<tr>
<td>RTN_LOCAL</td>
<td>0</td>
<td>RT_SCOPE_HOST</td>
</tr>
<tr>
<td>RTN_BROADCAST</td>
<td>0</td>
<td>RT_SCOPE_LINK</td>
</tr>
<tr>
<td>RTN_ANYCAST</td>
<td>0</td>
<td>RT_SCOPE_LINK</td>
</tr>
<tr>
<td>RTN_MULTICAST</td>
<td>0</td>
<td>RT_SCOPE_UNIVERSE</td>
</tr>
<tr>
<td>RTN_BLACKHOLE</td>
<td>-EINVAL</td>
<td>RT_SCOPE_UNIVERSE</td>
</tr>
<tr>
<td>RTN_UNREACHABLE</td>
<td>-EHOSTUNREACH</td>
<td>RT_SCOPE_UNIVERSE</td>
</tr>
<tr>
<td>RTN_PROHIBIT</td>
<td>-EACCES</td>
<td>RT_SCOPE_UNIVERSE</td>
</tr>
<tr>
<td>RTN_THROW</td>
<td>-EAGAIN</td>
<td>RT_SCOPE_UNIVERSE</td>
</tr>
<tr>
<td>RTN_NAT</td>
<td>-EINVAL</td>
<td>RT_SCOPE_NOWHERE</td>
</tr>
<tr>
<td>RTN_XRESOLVE</td>
<td>-EINVAL</td>
<td>RT_SCOPE_NOWHERE</td>
</tr>
</tbody>
</table>
<h5 id="下一跳"><a href="#下一跳" class="headerlink" title="下一跳"></a>下一跳</h5><figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fib_nh</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>	*<span class="title">nh_dev</span>;</span> <span class="comment">//将流量传输到下一跳所使用的网络设备----网络设备被禁用，将发送NETDEV_DOWN通知。处理这种事件的FIB回调函数为fib_netdev_event()</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>	<span class="title">nh_hash</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_info</span>		*<span class="title">nh_parent</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nh_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>		nh_scope;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_MULTIPATH</span></span><br><span class="line">	<span class="keyword">int</span>			nh_weight;</span><br><span class="line">	<span class="keyword">int</span>			nh_power;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_CLASSID</span></span><br><span class="line">	__u32			nh_tclassid;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span>			nh_oif;</span><br><span class="line">	__be32			nh_gw;</span><br><span class="line">	__be32			nh_saddr;</span><br><span class="line">	<span class="keyword">int</span>			nh_saddr_genid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> __<span class="title">rcu</span> * __<span class="title">percpu</span> *<span class="title">nh_pcpu_rth_output</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> __<span class="title">rcu</span>	*<span class="title">nh_rth_input</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fnhe_hash_bucket</span>	*<span class="title">nh_exceptions</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="缓存下一跳"><a href="#缓存下一跳" class="headerlink" title="缓存下一跳"></a>缓存下一跳</h6><figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/************************</span></span><br><span class="line"><span class="comment"> * 该函数完成下一跳的缓存</span></span><br><span class="line"><span class="comment"> ************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">rt_cache_route</span><span class="params">(struct fib_nh *nh, struct rtable *rt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> *<span class="title">orig</span>, *<span class="title">prev</span>, **<span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> ret = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rt_is_input_route(rt)) &#123;</span><br><span class="line">		p = (struct rtable **)&amp;nh-&gt;nh_rth_input;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		p = (struct rtable **)__this_cpu_ptr(nh-&gt;nh_pcpu_rth_output);</span><br><span class="line">	&#125;</span><br><span class="line">	orig = *p;</span><br><span class="line"></span><br><span class="line">	prev = cmpxchg(p, orig, rt);</span><br><span class="line">	<span class="keyword">if</span> (prev == orig) &#123;</span><br><span class="line">		<span class="keyword">if</span> (orig)</span><br><span class="line">			rt_free(orig);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		ret = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="下一跳例外-nexthop-exception"><a href="#下一跳例外-nexthop-exception" class="headerlink" title="下一跳例外(nexthop exception)"></a>下一跳例外(nexthop exception)</h5><figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fib_nh_exception</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_nh_exception</span> __<span class="title">rcu</span>	*<span class="title">fnhe_next</span>;</span></span><br><span class="line">	__be32				fnhe_daddr;</span><br><span class="line">	u32				fnhe_pmtu;</span><br><span class="line">	__be32				fnhe_gw;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>			fnhe_expires;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> __<span class="title">rcu</span>		*<span class="title">fnhe_rth</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>			fnhe_stamp;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*************************************</span></span><br><span class="line"><span class="comment">fib_nh_exception对象是由方法update_or_create_fnhe()创建的</span></span><br><span class="line"><span class="comment">*************************************/</span></span><br></pre></td></tr></table></figure>
<h4 id="策略路由选择"><a href="#策略路由选择" class="headerlink" title="策略路由选择"></a>策略路由选择</h4><p>不使用策略路由选择（没有设置CONFIG_IP_MULTIPLE_TABLES时），将创建两个路由选择表：本地表和主表。主表ID为254（RT_TABLE_MAIN）,本地表ID为255（RT_TABLE_LOCAL）</p>
<h5 id="fib-info的创建"><a href="#fib-info的创建" class="headerlink" title="fib_info的创建"></a>fib_info的创建</h5><figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct fib_info *<span class="title">fib_create_info</span><span class="params">(struct fib_config *cfg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_info</span> *<span class="title">fi</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_info</span> *<span class="title">ofi</span>;</span></span><br><span class="line">	<span class="keyword">int</span> nhs = <span class="number">1</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">cfg</span>-&gt;<span class="title">fc_nlinfo</span>.<span class="title">nl_net</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cfg-&gt;fc_type &gt; RTN_MAX)</span><br><span class="line">		<span class="keyword">goto</span> err_inval;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fast check to catch the most weird cases */</span></span><br><span class="line">	<span class="keyword">if</span> (fib_props[cfg-&gt;fc_type].scope &gt; cfg-&gt;fc_scope)</span><br><span class="line">		<span class="keyword">goto</span> err_inval;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_MULTIPATH</span></span><br><span class="line">	<span class="keyword">if</span> (cfg-&gt;fc_mp) &#123;</span><br><span class="line">		nhs = fib_count_nexthops(cfg-&gt;fc_mp, cfg-&gt;fc_mp_len);</span><br><span class="line">		<span class="keyword">if</span> (nhs == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> err_inval;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	err = -ENOBUFS;</span><br><span class="line">	<span class="keyword">if</span> (fib_info_cnt &gt;= fib_info_hash_size) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> new_size = fib_info_hash_size &lt;&lt; <span class="number">1</span>;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> *<span class="title">new_info_hash</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> *<span class="title">new_laddrhash</span>;</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> bytes;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!new_size)</span><br><span class="line">			new_size = <span class="number">16</span>;</span><br><span class="line">		bytes = new_size * <span class="keyword">sizeof</span>(struct hlist_head *);</span><br><span class="line">		new_info_hash = fib_info_hash_alloc(bytes);</span><br><span class="line">		new_laddrhash = fib_info_hash_alloc(bytes);</span><br><span class="line">		<span class="keyword">if</span> (!new_info_hash || !new_laddrhash) &#123;</span><br><span class="line">			fib_info_hash_free(new_info_hash, bytes);</span><br><span class="line">			fib_info_hash_free(new_laddrhash, bytes);</span><br><span class="line">		&#125; <span class="keyword">else</span></span><br><span class="line">			fib_info_hash_move(new_info_hash, new_laddrhash, new_size);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!fib_info_hash_size)</span><br><span class="line">			<span class="keyword">goto</span> failure;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fi = kzalloc(<span class="keyword">sizeof</span>(*fi)+nhs*<span class="keyword">sizeof</span>(struct fib_nh), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (fi == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> failure;</span><br><span class="line">	<span class="keyword">if</span> (cfg-&gt;fc_mx) &#123;</span><br><span class="line">		fi-&gt;fib_metrics = kzalloc(<span class="keyword">sizeof</span>(u32) * RTAX_MAX, GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!fi-&gt;fib_metrics)</span><br><span class="line">			<span class="keyword">goto</span> failure;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		fi-&gt;fib_metrics = (u32 *) dst_default_metrics;</span><br><span class="line">	fib_info_cnt++;</span><br><span class="line"></span><br><span class="line">	fi-&gt;fib_net = hold_net(net);</span><br><span class="line">	fi-&gt;fib_protocol = cfg-&gt;fc_protocol;</span><br><span class="line">	fi-&gt;fib_scope = cfg-&gt;fc_scope;</span><br><span class="line">	fi-&gt;fib_flags = cfg-&gt;fc_flags;</span><br><span class="line">	fi-&gt;fib_priority = cfg-&gt;fc_priority;</span><br><span class="line">	fi-&gt;fib_prefsrc = cfg-&gt;fc_prefsrc;</span><br><span class="line">	fi-&gt;fib_type = cfg-&gt;fc_type;</span><br><span class="line"></span><br><span class="line">	fi-&gt;fib_nhs = nhs;</span><br><span class="line">	change_nexthops(fi) &#123;</span><br><span class="line">		nexthop_nh-&gt;nh_parent = fi;</span><br><span class="line">		nexthop_nh-&gt;nh_pcpu_rth_output = alloc_percpu(struct rtable __rcu *);</span><br><span class="line">		<span class="keyword">if</span> (!nexthop_nh-&gt;nh_pcpu_rth_output)</span><br><span class="line">			<span class="keyword">goto</span> failure;</span><br><span class="line">	&#125; endfor_nexthops(fi)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cfg-&gt;fc_mx) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nla</span>;</span></span><br><span class="line">		<span class="keyword">int</span> remaining;</span><br><span class="line"></span><br><span class="line">		nla_for_each_attr(nla, cfg-&gt;fc_mx, cfg-&gt;fc_mx_len, remaining) &#123;</span><br><span class="line">			<span class="keyword">int</span> type = nla_type(nla);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (type) &#123;</span><br><span class="line">				u32 val;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (type &gt; RTAX_MAX)</span><br><span class="line">					<span class="keyword">goto</span> err_inval;</span><br><span class="line">				val = nla_get_u32(nla);</span><br><span class="line">				<span class="keyword">if</span> (type == RTAX_ADVMSS &amp;&amp; val &gt; <span class="number">65535</span> - <span class="number">40</span>)</span><br><span class="line">					val = <span class="number">65535</span> - <span class="number">40</span>;</span><br><span class="line">				<span class="keyword">if</span> (type == RTAX_MTU &amp;&amp; val &gt; <span class="number">65535</span> - <span class="number">15</span>)</span><br><span class="line">					val = <span class="number">65535</span> - <span class="number">15</span>;</span><br><span class="line">				fi-&gt;fib_metrics[type - <span class="number">1</span>] = val;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cfg-&gt;fc_mp) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_MULTIPATH</span></span><br><span class="line">		err = fib_get_nhs(fi, cfg-&gt;fc_mp, cfg-&gt;fc_mp_len, cfg);</span><br><span class="line">		<span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> failure;</span><br><span class="line">		<span class="keyword">if</span> (cfg-&gt;fc_oif &amp;&amp; fi-&gt;fib_nh-&gt;nh_oif != cfg-&gt;fc_oif)</span><br><span class="line">			<span class="keyword">goto</span> err_inval;</span><br><span class="line">		<span class="keyword">if</span> (cfg-&gt;fc_gw &amp;&amp; fi-&gt;fib_nh-&gt;nh_gw != cfg-&gt;fc_gw)</span><br><span class="line">			<span class="keyword">goto</span> err_inval;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_CLASSID</span></span><br><span class="line">		<span class="keyword">if</span> (cfg-&gt;fc_flow &amp;&amp; fi-&gt;fib_nh-&gt;nh_tclassid != cfg-&gt;fc_flow)</span><br><span class="line">			<span class="keyword">goto</span> err_inval;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">goto</span> err_inval;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		struct fib_nh *nh = fi-&gt;fib_nh;</span><br><span class="line"></span><br><span class="line">		nh-&gt;nh_oif = cfg-&gt;fc_oif;</span><br><span class="line">		nh-&gt;nh_gw = cfg-&gt;fc_gw;</span><br><span class="line">		nh-&gt;nh_flags = cfg-&gt;fc_flags;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_CLASSID</span></span><br><span class="line">		nh-&gt;nh_tclassid = cfg-&gt;fc_flow;</span><br><span class="line">		<span class="keyword">if</span> (nh-&gt;nh_tclassid)</span><br><span class="line">			fi-&gt;fib_net-&gt;ipv4.fib_num_tclassid_users++;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_MULTIPATH</span></span><br><span class="line">		nh-&gt;nh_weight = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fib_props[cfg-&gt;fc_type].error) &#123;</span><br><span class="line">		<span class="keyword">if</span> (cfg-&gt;fc_gw || cfg-&gt;fc_oif || cfg-&gt;fc_mp)</span><br><span class="line">			<span class="keyword">goto</span> err_inval;</span><br><span class="line">		<span class="keyword">goto</span> link_it;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> (cfg-&gt;fc_type) &#123;</span><br><span class="line">		<span class="keyword">case</span> RTN_UNICAST:</span><br><span class="line">		<span class="keyword">case</span> RTN_LOCAL:</span><br><span class="line">		<span class="keyword">case</span> RTN_BROADCAST:</span><br><span class="line">		<span class="keyword">case</span> RTN_ANYCAST:</span><br><span class="line">		<span class="keyword">case</span> RTN_MULTICAST:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">goto</span> err_inval;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cfg-&gt;fc_scope &gt; RT_SCOPE_HOST)</span><br><span class="line">		<span class="keyword">goto</span> err_inval;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cfg-&gt;fc_scope == RT_SCOPE_HOST) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">fib_nh</span> *<span class="title">nh</span> = <span class="title">fi</span>-&gt;<span class="title">fib_nh</span>;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Local address is added. */</span></span><br><span class="line">		<span class="keyword">if</span> (nhs != <span class="number">1</span> || nh-&gt;nh_gw)</span><br><span class="line">			<span class="keyword">goto</span> err_inval;</span><br><span class="line">		nh-&gt;nh_scope = RT_SCOPE_NOWHERE;</span><br><span class="line">		nh-&gt;nh_dev = dev_get_by_index(net, fi-&gt;fib_nh-&gt;nh_oif);</span><br><span class="line">		err = -ENODEV;</span><br><span class="line">		<span class="keyword">if</span> (nh-&gt;nh_dev == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> failure;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		change_nexthops(fi) &#123;</span><br><span class="line">			err = fib_check_nh(cfg, fi, nexthop_nh);</span><br><span class="line">			<span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">goto</span> failure;</span><br><span class="line">		&#125; endfor_nexthops(fi)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fi-&gt;fib_prefsrc) &#123;</span><br><span class="line">		<span class="keyword">if</span> (cfg-&gt;fc_type != RTN_LOCAL || !cfg-&gt;fc_dst ||</span><br><span class="line">		    fi-&gt;fib_prefsrc != cfg-&gt;fc_dst)</span><br><span class="line">			<span class="keyword">if</span> (inet_addr_type(net, fi-&gt;fib_prefsrc) != RTN_LOCAL)</span><br><span class="line">				<span class="keyword">goto</span> err_inval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	change_nexthops(fi) &#123;</span><br><span class="line">		fib_info_update_nh_saddr(net, nexthop_nh);</span><br><span class="line">	&#125; endfor_nexthops(fi)</span><br><span class="line"></span><br><span class="line">link_it:</span><br><span class="line">	ofi = fib_find_info(fi); <span class="comment">//找到类似的对象，新创建的fib_info释放，将找到对象的引用计数（fib_treeref）加1</span></span><br><span class="line">	<span class="keyword">if</span> (ofi) &#123;</span><br><span class="line">		fi-&gt;fib_dead = <span class="number">1</span>;</span><br><span class="line">		free_fib_info(fi);</span><br><span class="line">		ofi-&gt;fib_treeref++;</span><br><span class="line">		<span class="keyword">return</span> ofi;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fi-&gt;fib_treeref++;</span><br><span class="line">	atomic_inc(&amp;fi-&gt;fib_clntref);</span><br><span class="line">	spin_lock_bh(&amp;fib_info_lock);</span><br><span class="line">	hlist_add_head(&amp;fi-&gt;fib_hash,</span><br><span class="line">		       &amp;fib_info_hash[fib_info_hashfn(fi)]);</span><br><span class="line">	<span class="keyword">if</span> (fi-&gt;fib_prefsrc) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> *<span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line">		head = &amp;fib_info_laddrhash[fib_laddr_hashfn(fi-&gt;fib_prefsrc)];</span><br><span class="line">		hlist_add_head(&amp;fi-&gt;fib_lhash, head);</span><br><span class="line">	&#125;</span><br><span class="line">	change_nexthops(fi) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> *<span class="title">head</span>;</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!nexthop_nh-&gt;nh_dev)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		hash = fib_devindex_hashfn(nexthop_nh-&gt;nh_dev-&gt;ifindex);</span><br><span class="line">		head = &amp;fib_info_devhash[hash];</span><br><span class="line">		hlist_add_head(&amp;nexthop_nh-&gt;nh_hash, head);</span><br><span class="line">	&#125; endfor_nexthops(fi)</span><br><span class="line">	spin_unlock_bh(&amp;fib_info_lock);</span><br><span class="line">	<span class="keyword">return</span> fi;</span><br><span class="line"></span><br><span class="line">err_inval:</span><br><span class="line">	err = -EINVAL;</span><br><span class="line"></span><br><span class="line">failure:</span><br><span class="line">	<span class="keyword">if</span> (fi) &#123;</span><br><span class="line">		fi-&gt;fib_dead = <span class="number">1</span>;</span><br><span class="line">		free_fib_info(fi);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="生成ICMPv4重定向消息"><a href="#生成ICMPv4重定向消息" class="headerlink" title="生成ICMPv4重定向消息"></a>生成ICMPv4重定向消息</h4><ul>
<li><code>__mkroute_input()</code>方法中，必要时会设置<code>RTCF_DOREDIRECT</code></li>
<li><code>ip_forward()</code>中，调用方法<code>ip_rt_send_redirect()</code>来发送ICMPv4重定向消息</li>
</ul>
<p>满足如下条件会设置<code>RTCF_DOREDIRECT</code></p>
<ul>
<li>输入设备和输出设备相同</li>
<li>procfs条目/proc/sys/net/ipv4/conf/<dev name="">/send_redirects被设置</dev></li>
<li>输出设备为共享介质，或原地址和下一跳的网关同属一个子网<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (out_dev == in_dev &amp;&amp; err &amp;&amp; IN_DEV_TX_REDIRECTS(out_dev) &amp;&amp;</span><br><span class="line">	    (IN_DEV_SHARED_MEDIA(out_dev) ||</span><br><span class="line">	     inet_addr_onlink(out_dev, saddr, FIB_RES_GW(*res)))) &#123;</span><br><span class="line">		flags |= RTCF_DOREDIRECT;</span><br><span class="line">		do_cache = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	We now generate an ICMP HOST REDIRECT giving the route</span></span><br><span class="line"><span class="comment"> *	we calculated.</span></span><br><span class="line"><span class="comment"> */</span>	<span class="comment">//检查是否设置RTCF_DOREDIRECT，是否不包含IP选项（严格路由），且不是IPsec数据包</span></span><br><span class="line">  <span class="keyword">if</span> (rt-&gt;rt_flags&amp;RTCF_DOREDIRECT &amp;&amp; !opt-&gt;srr &amp;&amp; !skb_sec_path(skb))</span><br><span class="line">    ip_rt_send_redirect(skb);</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ip_rt_send_redirect</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  .................</span><br><span class="line">  icmp_send(skb, ICMP_REDIRECT, ICMP_REDIR_HOST,</span><br><span class="line">    rt_nexthop(rt, ip_hdr(skb)-&gt;daddr));</span><br><span class="line">  ....................</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="接收ICMPv4重定向消息"><a href="#接收ICMPv4重定向消息" class="headerlink" title="接收ICMPv4重定向消息"></a>接收ICMPv4重定向消息</h4><p><code>__ip_do_redirect</code>完成接收。<br><figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __ip_do_redirect(struct rtable *rt, struct sk_buff *skb, struct flowi4 *fl4,</span><br><span class="line">			     <span class="keyword">bool</span> kill_route)</span><br><span class="line">&#123;</span><br><span class="line">	__be32 new_gw = icmp_hdr(skb)-&gt;un.gateway;</span><br><span class="line">	__be32 old_gw = ip_hdr(skb)-&gt;saddr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span> = <span class="title">skb</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">in_device</span> *<span class="title">in_dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fib_result</span> <span class="title">res</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">neighbour</span> *<span class="title">n</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (icmp_hdr(skb)-&gt;code &amp; <span class="number">7</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> ICMP_REDIR_NET:</span><br><span class="line">	<span class="keyword">case</span> ICMP_REDIR_NETTOS:</span><br><span class="line">	<span class="keyword">case</span> ICMP_REDIR_HOST:</span><br><span class="line">	<span class="keyword">case</span> ICMP_REDIR_HOSTTOS:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rt-&gt;rt_gateway != old_gw)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	in_dev = __in_dev_get_rcu(dev);</span><br><span class="line">	<span class="keyword">if</span> (!in_dev)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	net = dev_net(dev);</span><br><span class="line">	<span class="keyword">if</span> (new_gw == old_gw || !IN_DEV_RX_REDIRECTS(in_dev) ||</span><br><span class="line">	    ipv4_is_multicast(new_gw) || ipv4_is_lbcast(new_gw) ||</span><br><span class="line">	    ipv4_is_zeronet(new_gw))</span><br><span class="line">		<span class="keyword">goto</span> reject_redirect;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!IN_DEV_SHARED_MEDIA(in_dev)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!inet_addr_onlink(in_dev, new_gw, old_gw))</span><br><span class="line">			<span class="keyword">goto</span> reject_redirect;</span><br><span class="line">		<span class="keyword">if</span> (IN_DEV_SEC_REDIRECTS(in_dev) &amp;&amp; ip_fib_check_default(new_gw, dev))</span><br><span class="line">			<span class="keyword">goto</span> reject_redirect;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (inet_addr_type(net, new_gw) != RTN_UNICAST)</span><br><span class="line">			<span class="keyword">goto</span> reject_redirect;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//在邻接子系统中查找</span></span><br><span class="line">	n = ipv4_neigh_lookup(&amp;rt-&gt;dst, <span class="literal">NULL</span>, &amp;new_gw);</span><br><span class="line">	<span class="keyword">if</span> (n) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(n-&gt;nud_state &amp; NUD_VALID)) &#123;</span><br><span class="line">			neigh_event_send(n, <span class="literal">NULL</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (fib_lookup(net, fl4, &amp;res) == <span class="number">0</span>) &#123;</span><br><span class="line">				struct fib_nh *nh = &amp;FIB_RES_NH(res);</span><br><span class="line">        <span class="comment">//创建或更新fib nexthop exception</span></span><br><span class="line">				update_or_create_fnhe(nh, fl4-&gt;daddr, new_gw,</span><br><span class="line">						      <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (kill_route)</span><br><span class="line">				rt-&gt;dst.obsolete = DST_OBSOLETE_KILL;</span><br><span class="line">			call_netevent_notifiers(NETEVENT_NEIGH_UPDATE, n);</span><br><span class="line">		&#125;</span><br><span class="line">		neigh_release(n);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">reject_redirect:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_ROUTE_VERBOSE</span></span><br><span class="line">	<span class="keyword">if</span> (IN_DEV_LOG_MARTIANS(in_dev)) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> = (<span class="title">const</span> <span class="title">struct</span> <span class="title">iphdr</span> *) <span class="title">skb</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line">		__be32 daddr = iph-&gt;daddr;</span><br><span class="line">		__be32 saddr = iph-&gt;saddr;</span><br><span class="line"></span><br><span class="line">		net_info_ratelimited(<span class="string">"Redirect from %pI4 on %s about %pI4 ignored\n"</span></span><br><span class="line">				     <span class="string">"  Advised path = %pI4 -&gt; %pI4\n"</span>,</span><br><span class="line">				     &amp;old_gw, dev-&gt;name, &amp;new_gw,</span><br><span class="line">				     &amp;saddr, &amp;daddr);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/10/09/IPv4路由子选择系统/" data-id="cjbtc2nf60000h8s94lbrqvnu" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内核网络/">内核网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-保留地址及检测方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/30/保留地址及检测方法/" class="article-date">
  <time datetime="2017-09-30T11:19:17.000Z" itemprop="datePublished">2017-09-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/30/保留地址及检测方法/">保留地址及检测方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>所有源码来自<a href="https://www.kernel.org" target="_blank" rel="noopener">kernel.org</a><br>内核版本号3.10</p>
</blockquote>
<p>所在目录/include/linux/in.h</p>
<figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// - 0111 1111|xxxx xxxx|xxxx xxxx|xxxx xxxx - loopback地址</span></span><br><span class="line"><span class="comment">// - 127.x.x.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_loopback</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xff000000</span>)) == htonl(<span class="number">0x7f000000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 1110 xxxx|xxxx xxxx|xxxx xxxx|xxxx xxxx 多播地址</span></span><br><span class="line"><span class="comment">// - 224.x.x.x - 239.x.x.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_multicast</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xf0000000</span>)) == htonl(<span class="number">0xe0000000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 1110 0000|0000 0000|0000 0000|xxxx xxxx 本地多播</span></span><br><span class="line"><span class="comment">// - 224.0.0.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_local_multicast</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xffffff00</span>)) == htonl(<span class="number">0xe0000000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 255.255.255.255 本地广播</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_lbcast</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* limited broadcast */</span></span><br><span class="line">	<span class="keyword">return</span> addr == htonl(INADDR_BROADCAST);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 0000 0000|xxxx xxxx|xxxx xxxx|xxxx xxxx - zeronet</span></span><br><span class="line"><span class="comment">// - 0.x.x.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_zeronet</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xff000000</span>)) == htonl(<span class="number">0x00000000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Special-Use IPv4 Addresses (RFC3330) */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// - 0000 1010|xxxx xxxx|xxxx xxxx|xxxx xxxx - private_10</span></span><br><span class="line"><span class="comment">// - 10.x.x.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_private_10</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xff000000</span>)) == htonl(<span class="number">0x0a000000</span>); <span class="comment">// - 10.x.x.x</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 1010 1100|0001 xxxx|xxxx xxxx|xxxx xxxx - private_172</span></span><br><span class="line"><span class="comment">// - 172.16.x.x - 172.31.x.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_private_172</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xfff00000</span>)) == htonl(<span class="number">0xac100000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 1100 0000|1010 1000|xxxx xxxx|xxxx xxxx - private_192</span></span><br><span class="line"><span class="comment">// - 192.168.x.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_private_192</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xffff0000</span>)) == htonl(<span class="number">0xc0a80000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 1010 1001|1111 1110|xxxx xxxx|xxxx xxxx</span></span><br><span class="line"><span class="comment">// - 169.254.x.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_linklocal_169</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xffff0000</span>)) == htonl(<span class="number">0xa9fe0000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 1100 0000|0101 1000|0110 0011|xxxx xxxx</span></span><br><span class="line"><span class="comment">// - 192.88.99.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_anycast_6to4</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xffffff00</span>)) == htonl(<span class="number">0xc0586300</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 1100 0000|0000 0000|0000 0010|xxxx xxxx</span></span><br><span class="line"><span class="comment">// - 192.0.2.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_test_192</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xffffff00</span>)) == htonl(<span class="number">0xc0000200</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// - 1100 0110|0001 001x|xxxx xxxx|xxxx xxxx</span></span><br><span class="line"><span class="comment">// - 198.18.x.x - 198.19.x.x</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ipv4_is_test_198</span><span class="params">(__be32 addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (addr &amp; htonl(<span class="number">0xfffe0000</span>)) == htonl(<span class="number">0xc6120000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/09/30/保留地址及检测方法/" data-id="cjbtc2ngi000kh8s9bhm3ieoq" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内核网络/">内核网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-fib-table-lookup路由查表过程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/29/fib-table-lookup路由查表过程分析/" class="article-date">
  <time datetime="2017-09-29T14:34:12.000Z" itemprop="datePublished">2017-09-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/29/fib-table-lookup路由查表过程分析/">fib_table_lookup路由查表过程分析 - Linux-3.10</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文主要分析fib_table_lookup()函数回溯(backtrace)部分的处理，其他内容之后再补充，另外或许A7可以匹配到A6，这部分内容不太确定，完后再做确认。</p>
</blockquote>
<h4 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h4><p>所有源码来自<a href="https://www.kernel.org/" target="_blank" rel="noopener">kernel.org</a>，本文并未将该函数的全部内容列出<br><figure class="highlight c"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment"> *	内核版本3.10</span></span><br><span class="line"><span class="comment"> *	函数位置：/net/ipv4/fib_trie.c	1405行</span></span><br><span class="line"><span class="comment"> *	函数说明：路由查表用函数，</span></span><br><span class="line"><span class="comment"> *	调用过程：ip_route_input_slow()-&gt;fib_lookup()-&gt;fib_table_lookup()</span></span><br><span class="line"><span class="comment"> *********************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fib_table_lookup</span><span class="params">(struct fib_table *tb, <span class="keyword">const</span> struct flowi4 *flp,</span></span></span><br><span class="line"><span class="function"><span class="params">		     struct fib_result *res, <span class="keyword">int</span> fib_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">@block_1：</span><br><span class="line">	note:所需数据结构定义以及初始化</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tnode</span> *<span class="title">pn</span>;</span>	<span class="comment">//用作父节点	parent node;</span></span><br><span class="line">	t_key key = ntohl(flp-&gt;daddr);	<span class="comment">//待查找的地址</span></span><br><span class="line">	t_key cindex = <span class="number">0</span>;	<span class="comment">//子节点的索引号	child index</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tnode</span> *<span class="title">cn</span>;</span>	<span class="comment">//用作子节点	child node;</span></span><br><span class="line">@block_2:</span><br><span class="line">	note:首先从根节点开始，n为null，则直接到(failed)去处理，返回<span class="number">1</span>,退出查找</span><br><span class="line">	n = rcu_dereference(t-&gt;trie);</span><br><span class="line">	<span class="keyword">if</span> (!n)</span><br><span class="line">		<span class="keyword">goto</span> failed;</span><br><span class="line">@block_3:</span><br><span class="line">	note:根为leaf，则直接检查leaf的信息，之后跳转到(found)去处理，返回ret，退出查找</span><br><span class="line">	<span class="keyword">if</span> (IS_LEAF(n)) &#123;</span><br><span class="line">		ret = check_leaf(tb, t, (struct leaf *)n, key, flp, res, fib_flags);</span><br><span class="line">		<span class="keyword">goto</span> found;</span><br><span class="line">	&#125;</span><br><span class="line">@block_4:</span><br><span class="line">	note:该部分处理n为tnode</span><br><span class="line">	pn = (struct tnode *) n;	<span class="comment">//n为一个tnode，接下来要把这个tnode作为一个parent node来用，然后，查找它的child node</span></span><br><span class="line">	chopped_off = <span class="number">0</span>;	<span class="comment">//这个变量用来保存不匹配的位数，不匹配的内容，我们需要把他切掉，</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (pn) &#123;</span><br><span class="line">		pos = pn-&gt;pos;	<span class="comment">//该node所匹配的可匹配地址的起始位，</span></span><br><span class="line">		bits = pn-&gt;bits;	<span class="comment">//表示起始位之后的位数</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!chopped_off)</span><br><span class="line">			cindex = tkey_extract_bits(mask_pfx(key, current_prefix_length),</span><br><span class="line">							 pos, bits);	<span class="comment">//取出bits，即child的索引</span></span><br><span class="line">		n = tnode_get_child_rcu(pn, cindex);	<span class="comment">//根据cindex取得child</span></span><br><span class="line"></span><br><span class="line">@block_4_1:</span><br><span class="line">		<span class="keyword">if</span> (n == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="keyword">goto</span> backtrace;</span><br><span class="line">		&#125;</span><br><span class="line">@block_4_2:</span><br><span class="line">		<span class="keyword">if</span> (IS_LEAF(n)) &#123;	<span class="comment">//child 是一个leaf，进行处理</span></span><br><span class="line">			ret = check_leaf(tb, t, (struct leaf *)n, key, flp, res, fib_flags);</span><br><span class="line">			<span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">goto</span> backtrace;</span><br><span class="line">			<span class="keyword">goto</span> found;</span><br><span class="line">		&#125;</span><br><span class="line">@block_4_3:</span><br><span class="line">		cn = (struct tnode *)n;	<span class="comment">//child 是一个node,进行处理</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (current_prefix_length &lt; pos+bits) &#123;</span><br><span class="line">			<span class="keyword">if</span> (tkey_extract_bits(cn-&gt;key, current_prefix_length,</span><br><span class="line">					cn-&gt;pos - current_prefix_length)</span><br><span class="line">					|| !(cn-&gt;child[<span class="number">0</span>]))</span><br><span class="line">				<span class="keyword">goto</span> backtrace;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pref_mismatch = mask_pfx(cn-&gt;key ^ key, cn-&gt;pos);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pref_mismatch) &#123;</span><br><span class="line">			<span class="comment">/* fls(x) = __fls(x) + 1 */</span></span><br><span class="line">			<span class="keyword">int</span> mp = KEYLENGTH - __fls(pref_mismatch) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (tkey_extract_bits(cn-&gt;key, mp, cn-&gt;pos - mp) != <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">goto</span> backtrace;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (current_prefix_length &gt;= cn-&gt;pos)</span><br><span class="line">				current_prefix_length = mp;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pn = (struct tnode *)n; <span class="comment">/* Descend */</span></span><br><span class="line">		chopped_off = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">backtrace:</span><br><span class="line">		chopped_off++;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* As zero don't change the child key (cindex) */</span></span><br><span class="line">		<span class="keyword">while</span> ((chopped_off &lt;= pn-&gt;bits) &amp;&amp; !(cindex &amp; (<span class="number">1</span>&lt;&lt;(chopped_off<span class="number">-1</span>))))</span><br><span class="line">			chopped_off++;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Decrease current_... with bits chopped off */</span></span><br><span class="line">		<span class="keyword">if</span> (current_prefix_length &gt; pn-&gt;pos + pn-&gt;bits - chopped_off)</span><br><span class="line">			current_prefix_length = pn-&gt;pos + pn-&gt;bits - chopped_off;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Either we do the actual chop off according or if we have</span></span><br><span class="line"><span class="comment">		 * chopped off all bits in this tnode walk up to our parent.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (chopped_off &lt;= pn-&gt;bits) &#123;</span><br><span class="line">			cindex &amp;= ~(<span class="number">1</span> &lt;&lt; (chopped_off<span class="number">-1</span>));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			struct tnode *parent = node_parent_rcu((struct rt_trie_node *) pn);</span><br><span class="line">			<span class="keyword">if</span> (!parent)</span><br><span class="line">				<span class="keyword">goto</span> failed;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Get Child's index */</span></span><br><span class="line">			cindex = tkey_extract_bits(pn-&gt;key, parent-&gt;pos, parent-&gt;bits);</span><br><span class="line">			pn = parent;</span><br><span class="line">			chopped_off = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">goto</span> backtrace;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line">	ret = <span class="number">1</span>;</span><br><span class="line">found:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="已有路由项"><a href="#已有路由项" class="headerlink" title="已有路由项"></a>已有路由项</h4><table>
<thead>
<tr>
<th>标号</th>
<th>地址</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
</tr>
</thead>
<tbody>
<tr>
<td>A1</td>
<td>192.168.10.0/24</td>
<td>11000000</td>
<td>10101000</td>
<td>00001010</td>
<td>00000000</td>
</tr>
<tr>
<td>A2</td>
<td>192.168.20.0/24</td>
<td>11000000</td>
<td>10101000</td>
<td>00010100</td>
<td>00000000</td>
</tr>
<tr>
<td>A3</td>
<td>2.232.20.0/24</td>
<td>00000010</td>
<td>11101000</td>
<td>00010100</td>
<td>00000000</td>
</tr>
<tr>
<td>A4</td>
<td>192.168.20.32/30</td>
<td>11000000</td>
<td>10101000</td>
<td>00010100</td>
<td>00100000</td>
</tr>
<tr>
<td>A5</td>
<td>192.168.20.4/30</td>
<td>11000000</td>
<td>10101000</td>
<td>00010100</td>
<td>00000100</td>
</tr>
<tr>
<td>A6</td>
<td>0.0.0.0/0</td>
<td>00000000</td>
<td>00000000</td>
<td>00000000</td>
<td>00000000</td>
</tr>
</tbody>
</table>
<h4 id="路由树结构"><a href="#路由树结构" class="headerlink" title="路由树结构"></a>路由树结构</h4><ul>
<li>(pos=0,bits=3)<ul>
<li>000   (pos=6,bits=1)<ul>
<li>0   [A6]</li>
<li>1   [A3]</li>
</ul>
</li>
<li>110   (pos=19,bits=2)<ul>
<li>01   [A1]</li>
<li>10   (pos=26,bits=1)<ul>
<li>1   [A4]</li>
<li>0   (pos=29,bits=1)<ul>
<li>0   [A2]</li>
<li>1   [A5]</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="待查找ip"><a href="#待查找ip" class="headerlink" title="待查找ip"></a>待查找ip</h4><table>
<thead>
<tr>
<th>标号</th>
<th>地址</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
</tr>
</thead>
<tbody>
<tr>
<td>A7</td>
<td>64.X.X.X/24</td>
<td>01000000</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
</tbody>
</table>
<h4 id="查找过程"><a href="#查找过程" class="headerlink" title="查找过程"></a>查找过程</h4><ol>
<li>首先从block_2开始，且根不为null，之后到block_3；</li>
<li>根是一个node，到block_4处理；</li>
<li>先看一下用到的几个变量（chopped_off = 0; pos =0; bits = 3；key = 64 X X X ）</li>
<li>根据pos、bits、key可以得到cindex = b010；</li>
<li>根据路由树结构，我们可以看出，该根node只有两个child，分别是[000]和[110]，因此对应cindex为空，则到block_4_1来处理。</li>
<li>发现没有child，会直接跳转到backtrace（回溯）来进行处理，这里解释一下回溯处理的目的，通过回溯来查找与cindex所指向的空child同一父node下的其他child的中能最长前缀匹配cindex的child。</li>
<li>先来直观的看一下cindex是如何与其他child最长前缀匹配的，cindex = [010];其他child = [000]、[110]，从左起第一位开始，[000] 和 [010] 都为0，左起第二位，不匹配了，所以这里最长匹配到第1位。假设有个child = [011]，则最长匹配到第2位。</li>
<li>下面给出backtrace处理过程中关键值的变化，pn-&gt;bits = 3没变</li>
</ol>
<table>
<thead>
<tr>
<th>说明</th>
<th>chopped_off</th>
<th>cindex</th>
<th>chopped_off &lt;= pn-&gt;bits</th>
<th>!(cindex &amp; (1&lt;&lt;(chopped_off-1)))</th>
</tr>
</thead>
<tbody>
<tr>
<td>while()条件处理</td>
<td>1</td>
<td>010b</td>
<td>真</td>
<td>!(010b &amp; 001b) 结果为非0</td>
</tr>
<tr>
<td>while内处理</td>
<td>2</td>
</tr>
<tr>
<td>while()条件处理</td>
<td>2</td>
<td>010b</td>
<td>真</td>
<td>!(010b &amp; 010b) 结果为0</td>
</tr>
</tbody>
</table>
<p>注释：while循环干了什么？<br>找到这bits位，最后一位为1的位置。那么找到了，就是右起第2位，之后会把这位值修改为0，设置成新cindex，通过{ cindex &amp;= ~(1 &lt;&lt; (chopped_off-1)) };完成修改。当前的前缀长度为1（current_prefix_length = 1 ）</p>
<ol>
<li>好了现在我们有新的cindex了，再返回while(pn)循环；</li>
<li>n = tnode_get_child_rcu(pn, cindex);该函数找到child，这次child是个leaf;</li>
<li>进入block_4_2去处理，check_leaf()返回的ret会大于0（注释：待补充解释），然后再次到backtrace去处理；</li>
<li>同样看相关值变化</li>
</ol>
<table>
<thead>
<tr>
<th>说明</th>
<th>chopped_off</th>
<th>cindex</th>
<th>chopped_off &lt;= pn-&gt;bits</th>
<th>!(cindex &amp; (1&lt;&lt;(chopped_off-1)))</th>
</tr>
</thead>
<tbody>
<tr>
<td>while()条件处理</td>
<td>3</td>
<td>000b</td>
<td>真</td>
<td>!(000b &amp; 001b) 结果为非0</td>
</tr>
<tr>
<td>while内处理</td>
<td>4</td>
</tr>
<tr>
<td>while()条件处理</td>
<td>4</td>
<td>000b</td>
<td>假</td>
<td>不考虑</td>
</tr>
</tbody>
</table>
<ol>
<li>current_prefix_length = pn-&gt;pos + pn-&gt;bits - chopped_off；结果为-1；</li>
<li>if (chopped_off &lt;= pn-&gt;bits)不满足此条件，会到cindex父node的父node，再继续匹配最长前缀，node_parent_rcu()获取到的父node为空，因此跳转到failed执行，退出。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/09/29/fib-table-lookup路由查表过程分析/" data-id="cjbtc2nfr0005h8s9lbcaof2o" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内核网络/">内核网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-markdown-syntax" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/27/markdown-syntax/" class="article-date">
  <time datetime="2017-09-27T05:16:02.000Z" itemprop="datePublished">2017-09-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/27/markdown-syntax/">markdown语法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 这是&lt;h1&gt; 一级标题</span></span><br><span class="line"><span class="section">## 这是&lt;h2&gt; 二级标题</span></span><br><span class="line"><span class="section">### 这是&lt;h3&gt; 三级标题</span></span><br><span class="line"><span class="section">#### 这是&lt;h4&gt; 四级标题</span></span><br><span class="line"><span class="section">##### 这是&lt;h5&gt; 五级标题</span></span><br><span class="line"><span class="section">###### 这是&lt;h6&gt; 六级标题</span></span><br></pre></td></tr></table></figure>
<h1 id="这是一级标题"><a href="#这是一级标题" class="headerlink" title="这是一级标题"></a>这是一级标题</h1><h2 id="这是二级标题"><a href="#这是二级标题" class="headerlink" title="这是二级标题"></a>这是二级标题</h2><h3 id="这是三级标题"><a href="#这是三级标题" class="headerlink" title="这是三级标题"></a>这是三级标题</h3><h4 id="这是四级标题"><a href="#这是四级标题" class="headerlink" title="这是四级标题"></a>这是四级标题</h4><h5 id="这是五级标题"><a href="#这是五级标题" class="headerlink" title="这是五级标题"></a>这是五级标题</h5><h6 id="这是六级标题"><a href="#这是六级标题" class="headerlink" title="这是六级标题"></a>这是六级标题</h6><h3 id="给标题添加class和id"><a href="#给标题添加class和id" class="headerlink" title="给标题添加class和id"></a>给标题添加<em>class</em>和<em>id</em></h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 这个标题拥有一个id &#123;#my_id&#125;</span></span><br><span class="line"><span class="section"># 这个标题有两个classes &#123;.class1 .class2&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="强调"><a href="#强调" class="headerlink" title="强调"></a>强调</h2><p><em>这会是 斜体 的文字</em><br><em>这会是 斜体 的文字</em></p>
<p><strong>这会是 粗体 的文字</strong><br><strong>这会是 粗体 的文字</strong></p>
<p><em>你也 <strong>组合</strong> 这些符号</em></p>
<p><del>这个文字将会被横线删除</del></p>
<h2 id="无序列表"><a href="#无序列表" class="headerlink" title="无序列表"></a>无序列表</h2><ul>
<li>Item 1</li>
<li>Item 2<ul>
<li>Item 2a</li>
<li>Item 2b<h2 id="有序列表"><a href="#有序列表" class="headerlink" title="有序列表"></a>有序列表</h2></li>
</ul>
</li>
</ul>
<ol>
<li>Item 1</li>
<li>Item 2</li>
<li>Item 3<ol>
<li>Item 3a</li>
<li>Item 3b</li>
</ol>
</li>
</ol>
<h2 id="添加图片"><a href="#添加图片" class="headerlink" title="添加图片"></a>添加图片</h2><p><img src="/images/avatar.jpg" alt="GitHub Logo"><br>Format: <img src="/images/wechatpay.jpg" alt="Alt Text"></p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p><a href="http://github.com" target="_blank" rel="noopener">http://github.com</a> - 自动生成！<br><a href="http://github.com" target="_blank" rel="noopener">GitHub</a></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>正如 Kanye West 所说：</p>
<blockquote>
<p>We’re living the future so<br>the present is our past.</p>
</blockquote>
<h2 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h2><p>如下，三个或者更多的</p>
<hr>
<p>连字符</p>
<hr>
<p>星号</p>
<hr>
<p>下划线</p>
<h2 id="行内代码"><a href="#行内代码" class="headerlink" title="行内代码"></a>行内代码</h2><p>我觉得你应该在这里使用<br><code>&lt;addr&gt;</code> 才对。</p>
<h2 id="代码行数"><a href="#代码行数" class="headerlink" title="代码行数"></a>代码行数</h2><p>如果你想要你的代码块显示代码行数，只要添加 line-numbers class 就可以了。<br><figure class="highlight javascript"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="任务列表"><a href="#任务列表" class="headerlink" title="任务列表"></a>任务列表</h2><ul>
<li style="list-style: none"><input type="checkbox" checked> @mentions, #refs, <a href="">links</a>, <strong>formatting</strong>, and <del>tags</del> supported</li>
<li style="list-style: none"><input type="checkbox" checked> list syntax required (any unordered or ordered list supported)</li>
<li style="list-style: none"><input type="checkbox" checked> this is a complete item</li>
<li style="list-style: none"><input type="checkbox"> this is an incomplete item</li>
</ul>
<h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><table>
<thead>
<tr>
<th>First Header</th>
<th>Second Header</th>
</tr>
</thead>
<tbody>
<tr>
<td>Content from cell 1</td>
<td>Content from cell 2</td>
</tr>
<tr>
<td>Content in the first column</td>
<td>Content in the second column</td>
</tr>
</tbody>
</table>
<h2 id="上标"><a href="#上标" class="headerlink" title="上标"></a>上标</h2><p>30^th^</p>
<h2 id="下标"><a href="#下标" class="headerlink" title="下标"></a>下标</h2><p>H~2~O</p>
<h2 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h2><p>Content [^1]</p>
<p>[^1]: Hi! This is a footnote</p>
<p>标记<br>==marked==</p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 开始</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">op=&gt;operation: 我的操作</span><br><span class="line">cond=&gt;condition: 确认？</span><br><span class="line"></span><br><span class="line">st-&gt;op-&gt;cond</span><br><span class="line">cond(yes)-&gt;e</span><br><span class="line">cond(no)-&gt;op</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/09/27/markdown-syntax/" data-id="cjbtc2nge000hh8s9o73nijph" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Linux-3-10-网桥转发数据过程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/26/Linux-3-10-网桥转发数据过程分析/" class="article-date">
  <time datetime="2017-09-26T08:42:39.000Z" itemprop="datePublished">2017-09-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Diary/">Diary</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/26/Linux-3-10-网桥转发数据过程分析/">Linux-3.10 网桥转发数据过程分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="内核网桥处理数据包流程分析"><a href="#内核网桥处理数据包流程分析" class="headerlink" title="内核网桥处理数据包流程分析"></a>内核网桥处理数据包流程分析</h1><p>Linux版本 : 3.10</p>
<p>具体内容待更新</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sophotomato.github.io/2017/09/26/Linux-3-10-网桥转发数据过程分析/" data-id="cjbtc2nfy0009h8s91mv9wpoy" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内核网络/">内核网络</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Diary/">Diary</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcc/">gcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内核网络/">内核网络</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/gcc/" style="font-size: 10px;">gcc</a> <a href="/tags/kernel/" style="font-size: 20px;">kernel</a> <a href="/tags/内核网络/" style="font-size: 20px;">内核网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/12/30/hello-world2/">Hello World</a>
          </li>
        
          <li>
            <a href="/2017/12/30/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2017/10/14/gcc/">gcc</a>
          </li>
        
          <li>
            <a href="/2017/10/10/ip-rcv-finish/">ip_rcv_finish()处理sk_buff数据分析</a>
          </li>
        
          <li>
            <a href="/2017/10/10/ip-rcv/">ip_rcv()处理sk_buff数据分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Wilson Wang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>